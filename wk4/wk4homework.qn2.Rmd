---
title: Week 4 Homework qn2
author: "Author: Laura Wooten"
output: 
  html_notebook
---
> 2. Download a data set from GEO that contains a continuous variable annotation. Build linear models of the effect of gene expression for each gene on the continuous variable (the continuous variable is the dependent variable). Then calculate confidence intervals for each model (use confint(), no need to try to calculate the intervals manually). Order the genes by their relationship to the dependent variable (e.g. p-value) and plot the confidence interval values. Describe results in plain English. Next, return the gene with the greatest and lowest predictive relationship and return the confidence intervals for each one of these. Describe these results.

```{r message=FALSE}
library(GEOquery)
geodata <-  getGEO("GSE27272", GSEMatrix = TRUE)
eset <- geodata[[1]]
edata <- exprs(eset)
pheno <- pData(eset)

```

```{r eval=FALSE, include=FALSE}
#for lower Ram
#edata50 <- exprs(geodata[[1]][1:50,]) #expression matrix
#save(edata50,file = "first50rows.rda")
#cord_conc <- as.numeric(gsub(".*: ","",pData(geodata[[1]])$characteristics_ch1.11))
#save(cord_conc, file = "cord_conc.rda")

#import data for posit lower ram
load("/cloud/project/wk4/cord_conc.rda") #edata50 (matrix [1:50, 1:183])
load("/cloud/project/wk4/first50rows.rda") #cord_conc (num [1:183])
```


**Define Variables:**  
Dependent continuous variable = "characteristics_ch1.11"   cord blood cotinine (ng/ml)
Independent variable = expression level.

```{r}
###########FOR FINAL FILE##########
pheno$characteristics_ch1.11[1:3]
cord_conc <- as.numeric(gsub(".*: ","",pheno$characteristics_ch1.11))
cord_conc[1:5]
###

#store results in df
exprs.lm.stats <- data.frame(
  gene = row.names(edata),
  coef.estimate = NA,
  pval= NA,
  ci.lower= NA,
  ci.upper= NA
)
#for (i in 1:2){
for (i in 1:length(edata[,1])){ #loop through rows
  tmp.df <- data.frame(G=edata[i,],CONC=cord_conc);#print(tmp.df) #make temporary df containing expression data and concentration (2 columns:expression level and concentration, 183 rows = 183 patients/samples)
  #fit linear model, save sample mean and pvalue of gene
  tmp.model <- lm(CONC~G, tmp.df) #fit linear model from df
  s.tmp.model <- summary(tmp.model)
  exprs.lm.stats$coef.estimate[i] <- coef(s.tmp.model)[2, "Estimate"]
  exprs.lm.stats$pval[i] <- coef(s.tmp.model)[2, "Pr(>|t|)"]
  
  #calc CIs for gene expression coefficient
  tmp.ci <- confint(tmp.model)
  exprs.lm.stats$ci.lower[i] <- tmp.ci[2,1] #G is on row two of tmp.ci
  exprs.lm.stats$ci.upper[i] <- tmp.ci[2,2]
}
```

```{r eval=FALSE, include=FALSE}
################LIMITED DATA SET FOR POSIT CLOUD###################
#store results in df
exprs.lm.stats <- data.frame(
  gene = row.names(edata50),
  coef.estimate = NA,
  pval= NA,
  ci.lower= NA,
  ci.upper= NA
)
#for (i in 1:2){
for (i in 1:length(edata50[,1])){ #loop through rows
  tmp.df <- data.frame(G=edata50[i,],CONC=cord_conc);#print(tmp.df) #make temporary df containing expression data and concentration (2 columns:expression level and concentration, 183 rows = 183 patients/samples)
  #fit linear model, save sample mean and pvalue of gene
  tmp.model <- lm(CONC~G, tmp.df) #fit linear model from df
  s.tmp.model <- summary(tmp.model)
  exprs.lm.stats$coef.estimate[i] <- coef(s.tmp.model)[2, "Estimate"]
  exprs.lm.stats$pval[i] <- coef(s.tmp.model)[2, "Pr(>|t|)"]
  
  #calc CIs for gene expression coefficient
  tmp.ci <- confint(tmp.model)
  exprs.lm.stats$ci.lower[i] <- tmp.ci[2,1] #G is on row two of tmp.ci
  exprs.lm.stats$ci.upper[i] <- tmp.ci[2,2]
}
```


Order genes by p-values & plot
```{r}
#sort df, ascending order
s.exprs.lm.stats <-  exprs.lm.stats[order(exprs.lm.stats$pval),]

#plot cis from sorted df
plot(1:nrow(s.exprs.lm.stats), s.exprs.lm.stats$coef.estimate, ylim=range(c(s.exprs.lm.stats$ci.lower, s.exprs.lm.stats$ci.upper, s.exprs.lm.stats$coef.estimate)), pch=19, xlab="Genes (sorted by p-value)", ylab="Coefficient estimate and CIs", main="Confidence intervals for concentration ~ gene expression")
arrows(1:nrow(s.exprs.lm.stats), s.exprs.lm.stats$ci.lower, 1:nrow(s.exprs.lm.stats), s.exprs.lm.stats$ci.upper, angle=90, code=3, length=0.1)
#overlay line at y=0 (smean = 0)
abline(h = 0, col = "green", lty=2, lwd = 2)
```
**DISCUSS**


Find gene with greatest and lowest predictive relationship & return results
```{r}
#We have negative and positive estimates of the coefficient > convert to absolute values
#create column in exprs.lm.stats that contains the absolute values (use abs())
exprs.lm.stats$abs.estimates <- abs(exprs.lm.stats$coef.estimate)

#find row index of max and min abs.estimates
max.i <- which.max(exprs.lm.stats$abs.estimates)
min.i <- which.min(exprs.lm.stats$abs.estimates)

#find gene name of each
max.gene <- exprs.lm.stats$gene[max.i]
min.gene <- exprs.lm.stats$gene[min.i]

#return details of each gene:
cat(sprintf("The gene with the greatest relationship to cotinine concentration in cord blood is %s, its coefficient estimate is: .4f, with 95%% confidence intervals of: %.4f - %.4f .\n", 
            max.gene, 
            exprs.lm.stats$coef.estimate[max.i], 
            exprs.lm.stats$ci.lower[max.i], 
            exprs.lm.stats$ci.upper[max.i]))

cat(sprintf("The gene with the least relationship to cotinine concentration in cord blood is %s, its coefficient estimate is: %.4f, with 95%% confidence intervals of: %.4f - %.4f.\n", 
            min.gene, 
            exprs.lm.stats$coef.estimate[min.i], 
            exprs.lm.stats$ci.lower[min.i], 
            exprs.lm.stats$ci.upper[min.i]))
```

